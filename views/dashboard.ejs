<!DOCTYPE html>
<html lang="en">
  <%- include("../components/Head", { title: "Dashboard"}) %>
  <body class="light" style="display: flex">
    <!-- Sidebar -->
    <%- include("../components/Sidebar", { active: "dashboard"}) %>
    <!-- Main -->
    <main id="dashboard-main">
      <h2>Hoşgeldiniz, <%= user ? user.ad_soyad : "Bilinmiyor" %>.</h2>
      <div class="dash-divider"></div>
      <div class="dashboard-flexbox">
        <div class="dashboard-item">
          <div class="col">
            <h4><%= totalProducts %></h4>
            <p>Toplam Ürün</p>
            <span class="stat-pin success">
              <span class="bxr bx-trending-up"></span>
              +12% bu ay
            </span>
          </div>
          <div class="col">
            <span class="bxr flexbox-icon" data-icon="package"></span>
          </div>
        </div>
        <div class="dashboard-item">
          <div class="col">
            <h4>₺<%= totalValue.toLocaleString() %></h4>
            <p>Toplam Değer</p>
            <span class="stat-pin success">
              <span class="bxr bx-trending-up"></span>
              +8.5% bu ay
            </span>
          </div>
          <div class="col">
            <span class="bxr flexbox-icon" data-icon="lira"></span>
          </div>
        </div>
        <div class="dashboard-item">
          <div class="col">
            <h4><%= totalCriticalStock %></h4>
            <p>Kritik Stok</p>
            <span class="stat-pin danger">
              <span class="bxr bx-trending-up"></span>
              İşlem gerekli
            </span>
          </div>
          <div class="col">
            <span class="bxr flexbox-icon" data-icon="alert-triangle"></span>
          </div>
        </div>
        <div class="dashboard-item">
          <div class="col">
            <h4><%= todayLogsLength %></h4>
            <p>Bugün Yapılan İşlem</p>
            <span class="stat-pin success">
              <span class="bxr bx-arrow-up"></span>
              17
              <span class="bxr bx-arrow-down"></span>
              10
            </span>
          </div>
          <div class="col">
            <span class="bxr flexbox-icon" data-icon="refresh-ccw-alt"></span>
          </div>
        </div>
      </div>
      <div class="dashboard-grid">
        <div class="grid-item">
          <h3>
            <span class="bxr bx-chart-bar-columns"></span>Kategori Bazlı Stok
            Dağılımı
          </h3>
          <div class="chart" id="categoryChart"></div>
        </div>
        <div class="grid-item">
          <h3>
            <span class="bxr bx-chart-line"></span>
            Son 15 Gün Stok Hareketleri
          </h3>
          <div class="chart" id="onbesChart"></div>
        </div>
        <div class="grid-item">
          <h3>
            <span class="bxr bx-alert-triangle"></span>
            Kritik Stok Ürünleri
            <a href="">Tümünü gör <span class="bxr bx-arrow-right"></span></a>
          </h3>
          <div class="critical-container">
            <% criticals.map((item) => { %>
            <div class="cr-item">
              <div class="row">
                <div class="col">
                  <div
                    class="circle circle-<%= item.mevcut_stok <= item.min_stok / 2 ? 'danger' : 'warning' %>"
                  ></div>
                </div>
                <div class="col">
                  <h4><%= item.urun_adi %></h4>
                  <p><%= item.urun_kategori %></p>
                </div>
              </div>
              <div class="col">
                <%= item.mevcut_stok %>/<%= item.max_stok ? item.max_stok : '-'
                %>
              </div>
            </div>
            <% }) %>
          </div>
        </div>
        <div class="grid-item">
          <h3>
            <span class="bxr bx-history"></span>
            Son Hareketler
            <a href="">Tümünü gör<span class="bxr bx-arrow-right"></span></a>
          </h3>
          <div class="last-container">
            <div class="timeline-line"></div>
            <div class="last-list">
              <% last5Logs.map((item) => { %>
              <div
                class="timeline-item stock-<%= item.hareket_turu == 'giris' ? 'add' : 'remove' %>"
              >
                <div class="timeline-time">
                  <%= new Date(item.created_at) .toLocaleTimeString("tr-TR", {
                  hour: "2-digit", minute: "2-digit" }); %>
                </div>
                <div class="timeline-content">
                  <h5>
                    <span
                      class="bxr bx-arrow-<%= item.hareket_turu == 'giris' ? 'up' : 'down' %>"
                    ></span
                    ><%= item.hareket_turu == 'giris' ? '+' : '-' %><%=
                    item.miktar %> | <%= item.urun_adi %>
                  </h5>
                  <p><%= item.ad_soyad %> tarafından</p>
                </div>
              </div>
              <% }) %>
            </div>
          </div>
        </div>
        <div class="grid-item flex-2">
          <h3>
            <span class="bxr bx-trophy-star"></span>
            Bu Ay En Çok Hareket Eden Ürünler
          </h3>
          <div class="best-container">
            <% if (topMovements && topMovements.length > 0) { %> <% const
            maxMiktar = topMovements[0].miktar; %> <%
            topMovements.forEach(function(item) { const percent =
            Math.round((item.miktar / maxMiktar) * 100); %>
            <div class="row">
              <h5><%= item.urun_adi %></h5>
              <div class="best-bar" style="width: <%= percent %>%">
                <%= item.miktar %>
              </div>
            </div>
            <% }) %> <% } else { %>
            <p>Son 1 ayda ürün hareketi bulunamadı.</p>
            <% } %>
          </div>
        </div>
      </div>
    </main>
  </body>
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script>
    var series = <%- JSON.stringify(categoryStats.map(s => s.adet)) %>;
    var labels = <%- JSON.stringify(categoryStats.map(s => s.kategori_adi)) %>;
    var options = {
      series: series,
      labels: labels,
      chart: {
        type: "donut",
      },
      responsive: [
        {
          breakpoint: 480,
          options: {
            chart: {
              width: 200,
            },
            legend: {
              position: "bottom",
            },
          },
        },
      ],
    };

    var chart = new ApexCharts(
      document.querySelector("#categoryChart"),
      options
    );
    chart.render();
  </script>
  <script>
    const last15 = <%- JSON.stringify(last15Days) %>;

    const data = last15.map(i => i.hareket_adedi);

    // x-axis kategori: 27/11 gibi TR formatı
    const categories = last15.map(i => {
      const d = new Date(i.tarih);
      return d.toLocaleDateString("tr-TR", {
        day: "2-digit",
        month: "2-digit"
      });
    });

    var options = {
      series: [
        {
          name: "Stok Hareketi",
          data: data,
        },
      ],
      chart: {
        height: 350,
        type: "bar",
      },
      plotOptions: {
        bar: {
          borderRadius: 6,
        },
      },
      dataLabels: {
        enabled: false
      },
      xaxis: {
        categories: categories,
      },
    };

    var chart = new ApexCharts(document.querySelector("#onbesChart"), options);
    chart.render();
  </script>
  <script src="/assets/js/generateColorFromStr.js"></script>
</html>
