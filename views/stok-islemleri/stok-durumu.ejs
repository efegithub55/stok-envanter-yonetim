<!DOCTYPE html>
<html lang="en">
  <!-- Head -->
  <%- include("../../components/Head", { title: "Stok Durumu "}) %>
  <body class="light" style="display: flex">
    <!-- Sidebar -->
    <%- include("../../components/Sidebar", { active: "stok-durumu" }) %>
    <!-- Alert -->
    <%- include("../../components/Alert") %>
    <!-- Main -->
    <main id="dashboard-main">
      <div class="dash-header">
        <div class="col">
          <h2>Stok Durumu</h2>
          <p>Tüm ürünlerinizin anlık stok seviyelerini görüntüleyin</p>
        </div>
      </div>

      <div class="dash-divider"></div>

      <% if (criticalCount > 0) { %>
      <div class="warning-box">
        <div class="col">
          <div class="row">
            <span class="bxr bxs-alert-triangle"></span>
          </div>
          <div class="row">
            <strong>Kritik Stok Uyarısı!</strong>
            <p>
              <%= criticalCount %> ürün kritik stok seviyesinin altında. Acil
              tedarik gerekiyor.
            </p>
          </div>
        </div>
      </div>
      <% } %>

      <!-- Üst istatistik kartları -->
      <div class="stats-grid">
  <!-- KRİTİK STOK -->
  <div class="stat-card danger">
    <div class="row">
      <div class="col"><div class="status danger"></div></div>
      <div class="col"><div class="stat-pin danger">Acil</div></div>
    </div>
    <div class="row">
      <p>Kritik Stok</p>
    </div>
    <div class="row">
      <h4><%= criticalCount %></h4>
    </div>
    <div class="row">
      <% const crit = trends && trends.critical ? trends.critical : 0; %>
      <div
        class="trend-bar <%= crit <= 0 ? 'success' : 'danger' %>"
      >
        <span
          class="bxr bx-arrow-<%= crit <= 0 ? 'down-stroke' : 'up-stroke' %>"
        ></span>
        <%= crit > 0 ? '+' : '' %><%= crit || 0 %> bu hafta
      </div>
    </div>
  </div>

  <!-- DÜŞÜK STOK -->
  <div class="stat-card warn">
    <div class="row">
      <div class="col"><div class="status warn"></div></div>
      <div class="col"><div class="stat-pin warn">Dikkat</div></div>
    </div>
    <div class="row">
      <p>Düşük Stok</p>
    </div>
    <div class="row">
      <h4><%= lowCount %></h4>
    </div>
    <div class="row">
      <% const low = trends && trends.low ? trends.low : 0; %>
      <div
        class="trend-bar <%= low <= 0 ? 'success' : 'danger' %>"
      >
        <span
          class="bxr bx-arrow-<%= low <= 0 ? 'down-stroke' : 'up-stroke' %>"
        ></span>
        <%= low > 0 ? '+' : '' %><%= low || 0 %> bu hafta
      </div>
    </div>
  </div>

  <!-- NORMAL STOK -->
  <div class="stat-card success">
    <div class="row">
      <div class="col"><div class="status success"></div></div>
      <div class="col"><div class="stat-pin success">Normal</div></div>
    </div>
    <div class="row">
      <p>Yeterli Stok</p>
    </div>
    <div class="row">
      <h4><%= normalCount %></h4>
    </div>
    <div class="row">
      <% const norm = trends && trends.normal ? trends.normal : 0; %>
      <div
        class="trend-bar <%= norm >= 0 ? 'success' : 'danger' %>"
      >
        <span
          class="bxr bx-arrow-<%= norm >= 0 ? 'up-stroke' : 'down-stroke' %>"
        ></span>
        <%= norm > 0 ? '+' : '' %><%= norm || 0 %> bu hafta
      </div>
    </div>
  </div>

  <!-- TOPLAM STOK DEĞERİ -->
  <div class="stat-card">
    <div class="row">
      <div class="col"><span class="bxr bx-dollar-circle"></span></div>
    </div>
    <div class="row">
      <p>Toplam Stok Değeri</p>
    </div>
    <div class="row">
      <h4>₺<%= (totalValue || 0).toLocaleString("tr-TR") %></h4>
    </div>
    <div class="row">
      <% const valRate = trends && typeof trends.valueRate === 'number'
          ? trends.valueRate
          : 0; %>
      <div
        class="trend-bar <%= valRate >= 0 ? 'success' : 'danger' %>"
      >
        <span
          class="bxr bx-arrow-<%= valRate >= 0 ? 'up-stroke' : 'down-stroke' %>"
        ></span>
        <%= (valRate >= 0 ? '+' : '') + valRate.toFixed(1) %>% bu hafta
      </div>
    </div>
  </div>
</div>

      <!-- Tabs + Search -->
      <div class="category-tabs-container">
        <div class="ct-tab-buttons">
          <div class="ct-tab-btn active" data-target="1">
            <p>Tümü</p>
            <div class="ct-tab-pin"><%= totalProduct %></div>
          </div>
          <div class="ct-tab-btn" data-target="2">
            <div class="circle circle-danger"></div>
            <p>Kritik</p>
            <div class="ct-tab-pin"><%= criticalCount %></div>
          </div>
          <div class="ct-tab-btn" data-target="3">
            <div class="circle circle-warning"></div>
            <p>Düşük</p>
            <div class="ct-tab-pin"><%= lowCount %></div>
          </div>
          <div class="ct-tab-btn" data-target="4">
            <div class="circle circle-success"></div>
            <p>Yeterli</p>
            <div class="ct-tab-pin"><%= normalCount %></div>
          </div>
        </div>

        <div class="ct-search-container">
          <form id="stock-search-form">
            <div class="inp-sec" method="get" action="/">
              <input
                type="text"
                placeholder="Ürün ara..."
                name="search"
                autocomplete="off"
              />
              <label for="search"><span class="bxr bx-search"></span></label>
            </div>
            <select
              name="category"
              onchange="event.preventDefault(); this.closest('form').submit();"
            >
              <option value="" >Tüm Kategoriler</option>
              <% categories.forEach((ctg) => { %>
              <option value="<%= ctg.id %>" <%= filters.category == ctg.id ? 'selected' : '' %>><%= ctg.kategori_adi %></option>
              <% }) %>
            </select>
            <select name="sort" onchange="event.preventDefault(); this.closest('form').submit();">
              <option value="default" <%= filters.sort == 'default' ? 'selected' : '' %>>Kritik -> Normal</option>
              <option value="lower" <%= filters.sort == 'lower' ? 'selected' : '' %>>En Az Stok</option>
              <option value="upper" <%= filters.sort == 'upper' ? 'selected' : '' %>>En Çok Stok</option>
              <option value="asc" <%= filters.sort == 'asc' ? 'selected' : '' %>>A-Z</option>
              <option value="desc" <%= filters.sort == 'desc' ? 'selected' : '' %>>Z-A</option>
            </select>
          </form>
        </div>

        <div class="dash-divider"></div>

        <!-- Tüm Ürünler -->
        <div class="product-container" data-id="1">
          <%- include("./partials/stok-durumu-list", { items: products,
          categories, lastEntries }) %>
        </div>

        <!-- Kritik Stok -->
        <div class="product-container hidden" data-id="2">
          <%- include("./partials/stok-durumu-list", { items: critical,
          categories, lastEntries }) %>
        </div>

        <!-- Düşük Stok -->
        <div class="product-container hidden" data-id="3">
          <%- include("./partials/stok-durumu-list", { items: low, categories,
          lastEntries }) %>
        </div>

        <!-- Yeterli Stok -->
        <div class="product-container hidden" data-id="4">
          <%- include("./partials/stok-durumu-list", { items: normal,
          categories, lastEntries }) %>
        </div>
      </div>
    </main>

    <!-- Scripts -->
    <script src="/assets/js/stockTabs.js"></script>
    <script>
  document.addEventListener("DOMContentLoaded", () => {
    document.addEventListener("click", (e) => {
      // STOK EKLE butonu
      const addBtn = e.target.closest(".add-stock");
      if (addBtn) {
        e.preventDefault();

        const row = addBtn.closest(".stock");
        if (!row) return;

        const btnAdd = row.querySelector(".add-stock");
        const btnRemove = row.querySelector(".remove-stock");
        const actionBar = row.querySelector(".stock-action-bar");
        const addForm = row.querySelector(".stock-add-form");
        const removeForm = row.querySelector(".stock-remove-form");

        btnAdd.classList.add("hidden");
        btnRemove.classList.add("hidden");

        actionBar.classList.remove("hidden");
        addForm.classList.remove("hidden");
        removeForm.classList.add("hidden");

        const input = addForm.querySelector('input[name="stok_ekle"]');
        if (input) input.focus();

        return;
      }

      // STOK ÇIKAR butonu
      const removeBtn = e.target.closest(".remove-stock");
      if (removeBtn) {
        e.preventDefault();

        const row = removeBtn.closest(".stock");
        if (!row) return;

        const btnAdd = row.querySelector(".add-stock");
        const btnRemove = row.querySelector(".remove-stock");
        const actionBar = row.querySelector(".stock-action-bar");
        const addForm = row.querySelector(".stock-add-form");
        const removeForm = row.querySelector(".stock-remove-form");

        btnAdd.classList.add("hidden");
        btnRemove.classList.add("hidden");

        actionBar.classList.remove("hidden");
        removeForm.classList.remove("hidden");
        addForm.classList.add("hidden");

        const input = removeForm.querySelector('input[name="stok_cikar"]');
        if (input) input.focus();

        return;
      }

      // İPTAL butonu
      const cancelBtn = e.target.closest(".stock-action-bar .cancel");
      if (cancelBtn) {
        e.preventDefault();

        const row = cancelBtn.closest(".stock");
        if (!row) return;

        const btnAdd = row.querySelector(".add-stock");
        const btnRemove = row.querySelector(".remove-stock");
        const actionBar = row.querySelector(".stock-action-bar");
        const addForm = row.querySelector(".stock-add-form");
        const removeForm = row.querySelector(".stock-remove-form");

        // inputları temizle
        const addInput = addForm.querySelector('input[name="stok_ekle"]');
        const removeInput = removeForm.querySelector('input[name="stok_cikar"]');
        if (addInput) addInput.value = "";
        if (removeInput) removeInput.value = "";

        // bar gizle, butonları geri göster
        actionBar.classList.add("hidden");
        btnAdd.classList.remove("hidden");
        btnRemove.classList.remove("hidden");

        return;
      }
    });
  });
</script>
  </body>
</html>
